<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta charset="UTF-8" />
    <title>Food Ingredient Scanner</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body {
        margin: 0;
        padding: 1em;
        background: #e0e0e0;
        font-family: "Segoe UI", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        overflow-x: hidden;
        text-align: center;
        box-sizing: border-box;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 0.5em;
        text-align: center;
      }

      .barcode {
        width: 300px;
        cursor: pointer;
        margin: 1.5em;
        transition: transform 0.2s ease;
      }

      .barcode:hover {
        transform: scale(1.1);
      }

      .scanner-text {
        font-size: 1em;
        color: #444;
        margin-bottom: 1em;
      }

      .start-button {
        background: #ff3cac;
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 50px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 1em;
        margin-bottom: 2em;
        box-shadow: 0 4px 15px rgba(255, 60, 172, 0.3);
        transition: all 0.3s ease;
      }

      .start-button:hover {
        background: #e6359a;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 60, 172, 0.4);
      }

      .start-button:active {
        transform: translateY(0);
      }

      .start-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .result {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(6px);
        border-radius: 12px;
        padding: 0.5em;
        width: 100%;
        max-width: 650px;
        margin-top: 3em;
        box-shadow: 0 9px 20px rgba(0, 0, 0, 0.1);
      }

      ul {
        list-style: none;
        padding: 0;
        margin-top: 1em;
      }

      li {
        font-size: 1em;
        margin: 0.5em 0;
        text-align: left;
      }

      .ingredient-category {
        margin-bottom: 1em;
      }

      .category-title {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.3em;
      }

      .ingredient-list {
        color: #666;
        margin-left: 1em;
        font-style: italic;
      }

      .safe-ingredients {
        color: #2a7f2a;
      }

      .risky-ingredients {
        color: #b30000;
      }

      .moderate-ingredients {
        color: #e69500;
      }

      .shower {
        position: fixed;
        top: -80px;
        width: 50px;
        height: 50px;
        z-index: 9999;
        animation: fall 8s linear forwards;
        pointer-events: none;
        opacity: 0.9;
      }

      @keyframes fall {
        0% {
          transform: translateY(-80px) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 0.8;
        }
        100% {
          transform: translateY(120vh) rotate(720deg);
          opacity: 0;
        }
      }

      .scan-again {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #ff3cac;
        color: white;
        padding: 10px 16px;
        border-radius: 40px;
        font-size: 1em;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .badge {
        margin-top: 1em;
        font-size: 1.1em;
        background: #fff3cd;
        color: #856404;
        padding: 0.75em 1em;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #funTip {
        margin-top: 1em;
        font-size: 1em;
        color: #006400;
        font-style: italic;
        line-height: 1.4;
        padding: 0.5em;
      }

      video,
      canvas {
        display: none;
      }

      .debug-info {
        margin-top: 1em;
        padding: 0.5em;
        background: #f0f0f0;
        border-radius: 5px;
        font-size: 0.8em;
        color: #666;
      }

      .try-again-header {
        color: #ff6b35;
        font-size: 1.5em;
        margin-bottom: 1em;
      }

      /* Subscription UI Styles */
      .subscription-banner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1em;
        margin: 1em 0;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        max-width: 500px;
        width: 100%;
      }

      .trial-status {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.8em;
        border-radius: 8px;
        margin-bottom: 1em;
        font-size: 0.9em;
      }

      .subscription-expired {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        padding: 2em;
        margin: 2em 0;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        max-width: 500px;
        width: 100%;
      }

      .subscribe-button {
        background: #4CAF50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        margin-top: 1em;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        transition: all 0.3s ease;
      }

      .subscribe-button:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
      }

      .price-info {
        font-size: 1.2em;
        margin: 0.5em 0;
        font-weight: bold;
      }

      .trial-countdown {
        font-size: 1.1em;
        color: #ff6b35;
        font-weight: bold;
        margin: 0.5em 0;
      }

      .features-list {
        text-align: left;
        margin: 1em 0;
        padding-left: 1em;
      }

      .features-list li {
        margin: 0.3em 0;
        font-size: 0.9em;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1em;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      }

      .notification.success {
        background: #4CAF50;
      }

      .notification.warning {
        background: #ff9800;
      }

      .notification.error {
        background: #f44336;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); }
        to { transform: translateX(0); }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <h1>Food Ingredient Scanner</h1>
    
    <!-- Subscription Status Banner -->
    <div id="subscriptionStatus"></div>
    
    <img
      src="/static/barcode.png"
      alt="scanner icon"
      class="barcode"
      onclick="checkAccessAndScan()"
    />
    <p class="scanner-text">üì∏ Take a photo of your food's ingredients</p>

    <button class="start-button" id="startButton" onclick="checkAccessAndScan()">START HERE</button>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="snapshot"></canvas>

    <form id="uploadForm" method="post" enctype="multipart/form-data">
      <input
        type="file"
        id="fileInput"
        name="image"
        accept="image/*"
        capture="environment"
        onchange="handleImageUpload(this)"
        style="display: none"
      />
    </form>

    <form
      id="scanForm"
      method="post"
      enctype="multipart/form-data"
      style="display: none"
    >
      <input id="hiddenImage" type="file" name="image" />
    </form>

    <!-- Subscription expired modal -->
    <div id="subscriptionModal" style="display: none;">
      <div class="subscription-expired">
        <h2>üîí Free Trial Expired</h2>
        <p>Your 48-hour free trial has ended. Continue enjoying unlimited ingredient scanning for just $2.99/month!</p>
        <div class="price-info">$2.99/month</div>
        <ul class="features-list">
          <li>‚úÖ Unlimited ingredient scans</li>
          <li>‚úÖ Advanced health risk analysis</li>
          <li>‚úÖ Personalized recommendations</li>
          <li>‚úÖ Cancel anytime</li>
        </ul>
        <button class="subscribe-button" onclick="initiateSubscription()">
          <span id="subscribeText">Subscribe Now</span>
        </button>
      </div>
    </div>

    <!-- Results section -->
    {% if result %}
    <div
      class="result {% if 'TRY AGAIN' in result.rating %}try-again {% elif 'Danger' in result.rating %}danger {% elif 'Proceed' in result.rating %}caution {% else %}safe{% endif %}"
    >
      {% if "TRY AGAIN" in result.rating or "Error" in result.rating %}
      <div class="try-again-header">‚Ü™Ô∏è TRY AGAIN</div>
      <p>
        We couldn't clearly read the ingredients. Please try taking a clearer
        photo with better lighting.
      </p>

      {% else %}
      <div
        style="
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 12px;
        "
      >
        {% if "Danger" in result.rating %}
        <img src="/static/danger.png" alt="Danger Emoji" width="50" />
        <h2 style="color: #b30000; margin: 0">Oh NOOOO! Danger!</h2>
        {% elif "Proceed" in result.rating %}
        <img src="/static/carefully.png" alt="Caution Emoji" width="50" />
        <h2 style="color: #e69500; margin: 0">Proceed carefully</h2>
        {% else %}
        <img src="/static/safe.png" alt="Safe Emoji" width="50" />
        <h2 style="color: #2a7f2a; margin: 0">Yay! Safe!</h2>
        {% endif %}
      </div>

      <h3>Detected Ingredients:</h3>

      <!-- Show safe ingredients when food is safe -->
      {% if result.matched_ingredients.safe_ingredients %}
      <div class="ingredient-category">
        <div class="category-title safe-ingredients">‚úÖ Safe Ingredients:</div>
        <div class="ingredient-list safe-ingredients">
          {{ result.matched_ingredients.safe_ingredients | join(", ") }}
        </div>
      </div>
      {% endif %}

      <!-- Show risky ingredients when found -->
      {% if result.matched_ingredients.trans_fat %}
      <div class="ingredient-category">
        <div class="category-title risky-ingredients">‚ö†Ô∏è Trans Fat:</div>
        <div class="ingredient-list risky-ingredients">
          {{ result.matched_ingredients.trans_fat | join(", ") }}
        </div>
      </div>
      {% endif %} {% if result.matched_ingredients.excitotoxins %}
      <div class="ingredient-category">
        <div class="category-title risky-ingredients">‚ö†Ô∏è Excitotoxins:</div>
        <div class="ingredient-list risky-ingredients">
          {{ result.matched_ingredients.excitotoxins | join(", ") }}
        </div>
      </div>
      {% endif %} {% if result.matched_ingredients.corn %}
      <div class="ingredient-category">
        <div class="category-title moderate-ingredients">üåΩ Corn-based:</div>
        <div class="ingredient-list moderate-ingredients">
          {{ result.matched_ingredients.corn | join(", ") }}
        </div>
      </div>
      {% endif %} {% if result.matched_ingredients.sugar %}
      <div class="ingredient-category">
        <div class="category-title moderate-ingredients">üçØ Sugars:</div>
        <div class="ingredient-list moderate-ingredients">
          {{ result.matched_ingredients.sugar | join(", ") }}
        </div>
      </div>
      {% endif %} {% if result.matched_ingredients.gmo %}
      <div class="ingredient-category">
        <div class="category-title moderate-ingredients">üß¨ GMO:</div>
        <div class="ingredient-list moderate-ingredients">
          {{ result.matched_ingredients.gmo | join(", ") }}
        </div>
      </div>
      {% endif %}

      <!-- Show all detected ingredients if none in specific categories -->
      {% if not result.matched_ingredients.safe_ingredients and not
      result.matched_ingredients.trans_fat and not
      result.matched_ingredients.excitotoxins and not
      result.matched_ingredients.corn and not result.matched_ingredients.sugar
      and not result.matched_ingredients.gmo %}
      <div class="ingredient-category">
        <div class="category-title">üìã All Detected:</div>
        <div class="ingredient-list">
          {% if result.matched_ingredients.all_detected %} {{
          result.matched_ingredients.all_detected | join(", ") }} {% else %} No
          ingredients clearly detected. Try taking a clearer photo. {% endif %}
        </div>
      </div>
      {% endif %}

      <div class="badge" id="scanBadge"></div>
      <p id="funTip"></p>
      {% endif %}

      <!-- Debug information (optional - remove in production) -->
      {% if result.confidence %}
      <div class="debug-info">
        Confidence: {{ result.confidence }} | Text Length: {{
        result.extracted_text_length }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <script>
      // Stripe configuration
      const stripe = Stripe('pk_test_your_stripe_publishable_key_here'); // Replace with your Stripe publishable key
      
      // User session management
      class SubscriptionManager {
        constructor() {
          this.userId = this.getUserId();
          this.trialStartTime = this.getTrialStartTime();
          this.subscriptionStatus = this.getSubscriptionStatus();
          this.init();
        }

        getUserId() {
          let userId = sessionStorage.getItem('userId');
          if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('userId', userId);
          }
          return userId;
        }

        getTrialStartTime() {
          let startTime = sessionStorage.getItem('trialStartTime');
          if (!startTime) {
            startTime = Date.now();
            sessionStorage.setItem('trialStartTime', startTime);
            this.notifyTrialStarted();
          }
          return parseInt(startTime);
        }

        getSubscriptionStatus() {
          return sessionStorage.getItem('subscriptionStatus') || 'trial';
        }

        setSubscriptionStatus(status) {
          this.subscriptionStatus = status;
          sessionStorage.setItem('subscriptionStatus', status);
        }

        isTrialExpired() {
          const now = Date.now();
          const trialDuration = 48 * 60 * 60 * 1000; // 48 hours in milliseconds
          return (now - this.trialStartTime) > trialDuration;
        }

        getTimeRemaining() {
          const now = Date.now();
          const trialDuration = 48 * 60 * 60 * 1000; // 48 hours
          const remaining = trialDuration - (now - this.trialStartTime);
          return Math.max(0, remaining);
        }

        formatTimeRemaining(ms) {
          const hours = Math.floor(ms / (1000 * 60 * 60));
          const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
          return `${hours}h ${minutes}m`;
        }

        hasAccess() {
          return this.subscriptionStatus === 'active' || !this.isTrialExpired();
        }

        init() {
          this.updateUI();
          this.startTrialCountdown();
          
          // Check subscription status with server
          this.checkServerSubscriptionStatus();
        }

        updateUI() {
          const statusContainer = document.getElementById('subscriptionStatus');
          const startButton = document.getElementById('startButton');
          
          if (this.subscriptionStatus === 'active') {
            statusContainer.innerHTML = `
              <div class="subscription-banner">
                <div class="trial-status">
                  ‚úÖ <strong>Premium Subscriber</strong> - Unlimited scans!
                </div>
              </div>
            `;
          } else if (this.isTrialExpired()) {
            statusContainer.innerHTML = `
              <div class="subscription-expired">
                <h3>üîí Free Trial Expired</h3>
                <p>Subscribe to continue scanning ingredients!</p>
                <div class="price-info">$2.99/month</div>
                <button class="subscribe-button" onclick="subscriptionManager.initiateSubscription()">
                  Subscribe Now
                </button>
              </div>
            `;
            startButton.disabled = true;
            startButton.textContent = 'Subscribe to Continue';
          } else {
            const remaining = this.getTimeRemaining();
            statusContainer.innerHTML = `
              <div class="subscription-banner">
                <div class="trial-status">
                  üéâ <strong>Free Trial Active</strong>
                  <div class="trial-countdown">
                    Time remaining: ${this.formatTimeRemaining(remaining)}
                  </div>
                </div>
                <div style="font-size: 0.9em; margin-top: 0.5em;">
                  After trial: $2.99/month for unlimited access
                </div>
              </div>
            `;
          }
        }

        startTrialCountdown() {
          setInterval(() => {
            if (this.subscriptionStatus !== 'active') {
              this.updateUI();
              
              // Notify when trial is about to expire (1 hour remaining)
              const remaining = this.getTimeRemaining();
              if (remaining <= 60 * 60 * 1000 && remaining > 59 * 60 * 1000) {
                this.showNotification('‚è∞ Trial expires in 1 hour! Subscribe to continue unlimited access.', 'warning');
              }
            }
          }, 60000); // Update every minute
        }

        async checkServerSubscriptionStatus() {
          try {
            const response = await fetch('/api/subscription-status', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ userId: this.userId })
            });
            
            if (response.ok) {
              const data = await response.json();
              if (data.status === 'active') {
                this.setSubscriptionStatus('active');
                this.updateUI();
              }
            }
          } catch (error) {
            console.error('Error checking subscription status:', error);
          }
        }

        async initiateSubscription() {
          const subscribeButton = document.querySelector('.subscribe-button');
          const originalText = subscribeButton.innerHTML;
          
          subscribeButton.innerHTML = '<div class="loading"></div>Creating subscription...';
          subscribeButton.disabled = true;

          try {
            // Create subscription session
            const response = await fetch('/api/create-subscription', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ 
                userId: this.userId,
                priceId: 'price_your_stripe_price_id_here' // Replace with your Stripe price ID
              })
            });

            if (!response.ok) {
              throw new Error('Failed to create subscription session');
            }

            const session = await response.json();
            
            // Redirect to Stripe Checkout
            const result = await stripe.redirectToCheckout({
              sessionId: session.sessionId
            });

            if (result.error) {
              throw new Error(result.error.message);
            }

          } catch (error) {
            console.error('Subscription error:', error);
            this.showNotification('‚ùå Subscription failed. Please try again.', 'error');
            subscribeButton.innerHTML = originalText;
            subscribeButton.disabled = false;
          }
        }

        notifyTrialStarted() {
          // Send notification about trial start
          fetch('/api/notify-trial-start', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
              userId: this.userId,
              startTime: this.trialStartTime
            })
          }).catch(console.error);
        }

        showNotification(message, type = 'success') {
          const notification = document.createElement('div');
          notification.className = `notification ${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);

          setTimeout(() => {
            notification.remove();
          }, 5000);
        }
      }

      // Initialize subscription manager
      const subscriptionManager = new SubscriptionManager();

      // Modified scanner functions
      function checkAccessAndScan() {
        if (!subscriptionManager.hasAccess()) {
          subscriptionManager.showNotification('‚è∞ Free trial expired! Subscribe to continue scanning.', 'warning');
          return;
        }
        triggerScanner();
      }

      function handleImageUpload(input) {
        if (!subscriptionManager.hasAccess()) {
          subscriptionManager.showNotification('‚è∞ Free trial expired! Subscribe to continue scanning.', 'warning');
          input.value = '';
          return;
        }
        input.form.submit();
      }

      // Original scanner functionality
      const isPhone = /android|iphone|ipad|ipod/i.test(navigator.userAgent);
      const video = document.getElementById("webcam");
      const canvas = document.getElementById("snapshot");

      function triggerScanner() {
        if (isPhone) {
          document.getElementById("fileInput").click();
        } else {
          video.style.display = "block";
          navigator.mediaDevices.enumerateDevices().then((devices) => {
            const cameras = devices.filter(
              (device) => device.kind === "videoinput"
            );
            const rearCamera =
              cameras.find((cam) => cam.label.toLowerCase().includes("back")) ||
              cameras[0];
            navigator.mediaDevices
              .getUserMedia({ video: { deviceId: rearCamera.deviceId } })
              .then(function (stream) {
                video.srcObject = stream;
                video.play();
                setTimeout(() => capture(), 1500);
              });
          });
        }
      }

      function capture() {
        const form = document.getElementById("scanForm");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        canvas.toBlob(function (blob) {
          const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
          const container = new DataTransfer();
          container.items.add(file);
          const input = document.getElementById("hiddenImage");
          input.files = container.files;
          form.submit();
        }, "image/jpeg");
      }

      // Handle successful subscription (called from success page)
      function handleSubscriptionSuccess() {
        subscriptionManager.setSubscriptionStatus('active');
        subscriptionManager.updateUI();
        subscriptionManager.showNotification('üéâ Subscription activated! Enjoy unlimited scanning!', 'success');
      }

      // Check if returning from successful subscription
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('subscription') === 'success') {
        handleSubscriptionSuccess();
      }
    </script>

    <a class="scan-again" href="/">üîÑ Scan Again</a>
  </body>
</html>
